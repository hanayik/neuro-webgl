(function(t){function e(e){for(var s,a,r=e[0],l=e[1],h=e[2],u=0,d=[];u<r.length;u++)a=r[u],Object.prototype.hasOwnProperty.call(n,a)&&n[a]&&d.push(n[a][0]),n[a]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(t[s]=l[s]);c&&c(e);while(d.length)d.shift()();return o.push.apply(o,h||[]),i()}function i(){for(var t,e=0;e<o.length;e++){for(var i=o[e],s=!0,r=1;r<i.length;r++){var l=i[r];0!==n[l]&&(s=!1)}s&&(o.splice(e--,1),t=a(a.s=i[0]))}return t}var s={},n={app:0},o=[];function a(e){if(s[e])return s[e].exports;var i=s[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=t,a.c=s,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)a.d(i,s,function(e){return t[e]}.bind(null,s));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],l=r.push.bind(r);r.push=e,r=r.slice();for(var h=0;h<r.length;h++)e(r[h]);var c=l;o.push([0,"chunk-vendors"]),i()})({0:function(t,e,i){t.exports=i("56d7")},"458d":function(t,e,i){},5243:function(t,e,i){"use strict";i.d(e,"a",(function(){return s}));i("466d"),i("ac1f"),i("159b");var s=function(t,e,i){var s=this;this.program=n(t,e,i);var o=/uniform[^;]+[ ](\w+);/g,a=/uniform[^;]+[ ](\w+);/;this.uniforms={};var r=e.match(o),l=i.match(o);for(var h in r&&r.forEach((function(t){var e=t.match(a);s.uniforms[e[1]]=-1})),l&&l.forEach((function(t){var e=t.match(a);s.uniforms[e[1]]=-1})),this.uniforms)this.uniforms[h]=t.getUniformLocation(this.program,h)};s.prototype.use=function(t){t.useProgram(this.program)};var n=function(t,e,i){var s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return alert("Vertex shader failed to compile, see console for log"),console.log(t.getShaderInfoLog(s)),null;var n=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))return alert("Fragment shader failed to compile, see console for log"),console.log(t.getShaderInfoLog(n)),null;var o=t.createProgram();return t.attachShader(o,s),t.attachShader(o,n),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(alert("Shader failed to link, see console for log"),console.log(t.getProgramInfoLog(o)),null)}},"56d7":function(t,e,i){"use strict";i.r(e);i("e260"),i("e6cf"),i("cca6"),i("a79d"),i("d1e78"),i("d4b8");var s=i("2b0e"),n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-app",[i("v-app-bar",{attrs:{app:""}},[i("h2",[t._v("Niivue")]),i("v-spacer")],1),i("v-main",[i("v-row",{staticStyle:{height:"100%"}},[i("v-col",{attrs:{sm:"12",md:"12",lg:"4"}},[i("controls",{attrs:{overlays:t.urlOverlayList}})],1),i("v-col",{attrs:{sm:"12",md:"12",lg:"8"}},[i("v-toolbar",{staticClass:"pa-0 ma-0",attrs:{elevation:"0"}},[i("v-btn",{on:{click:function(e){return t.setSliceType(0)}}},[t._v("A")]),i("v-btn",{on:{click:function(e){return t.setSliceType(2)}}},[t._v("S")]),i("v-btn",{on:{click:function(e){return t.setSliceType(1)}}},[t._v("C")]),i("v-btn",{on:{click:function(e){return t.setSliceType(4)}}},[t._v("R")]),i("v-btn",{on:{click:function(e){return t.setSliceType(3)}}},[t._v("MP")]),i("v-spacer")],1),1==t.viewShown2D||1==t.viewShown3D?i("v-expansion-panels",[i("v-expansion-panel",[i("v-expansion-panel-header",[i("v-row",{staticClass:"align-center",attrs:{"no-gutters":""}},[t._v(" Controls "),i("v-icon",{staticClass:"mx-2"},[t._v(" mdi-arrow-expand-vertical ")])],1)],1),i("v-expansion-panel-content",[1==t.viewShown2D?i("v-row",[i("v-slider",{attrs:{step:"0.01",max:"1",min:"0","thumb-label":"",label:"slice"},on:{input:t.onSliceSlider2D},model:{value:t.sliceScrollVal,callback:function(e){t.sliceScrollVal=e},expression:"sliceScrollVal"}})],1):t._e(),1==t.viewShown3D?i("v-row",[i("v-slider",{attrs:{step:"1",max:"360",min:"0","thumb-label":"",label:"clip Azimu"},on:{input:t.onClipPlaneChange},model:{value:t.clipValAz,callback:function(e){t.clipValAz=e},expression:"clipValAz"}})],1):t._e(),1==t.viewShown3D?i("v-row",[i("v-slider",{attrs:{step:"1",max:"90",min:"-90","thumb-label":"",label:"clip Eleva"},on:{input:t.onClipPlaneChange},model:{value:t.clipValEl,callback:function(e){t.clipValEl=e},expression:"clipValEl"}})],1):t._e(),1==t.viewShown3D?i("v-row",[i("v-slider",{attrs:{step:"0.005",max:"0.5",min:"0","thumb-label":"",label:"clip Depth"},on:{input:t.onClipPlaneChange},model:{value:t.clipValDepth,callback:function(e){t.clipValDepth=e},expression:"clipValDepth"}})],1):t._e(),i("v-row",[t.viewShown3D?i("v-btn",{staticClass:"mx-auto",on:{click:t.onResetClipPlane}},[t._v("reset")]):t._e()],1)],1)],1)],1):t._e(),i("glviewer",{attrs:{overlays:t.urlOverlayList}})],1)],1)],1),i("v-footer",{attrs:{app:""}},[i("v-row",[i("v-col",{attrs:{align:"center",justify:"center"}},[i("span",{staticClass:"text-caption"},[t._v(t._s(t.coordinateString))])])],1)],1)],1)},o=[],a=(i("b680"),i("1276"),i("ac1f"),function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"mt-5",attrs:{id:"controls"}},[i("v-row",{staticClass:"my-2 mx-2 align-center"},[i("h3",[t._v("Layers")]),i("v-spacer"),i("v-btn",{staticClass:"mx-2",attrs:{small:""},on:{click:t.onAddOverlay}},[t._v("Add overlay")])],1),i("v-row",{attrs:{"no-gutters":""}},[i("v-expansion-panels",[i("draggable",{staticClass:"row mx-2 my-2",attrs:{handle:".drag-handle"},model:{value:t.overlays,callback:function(e){t.overlays=e},expression:"overlays"}},t._l(t.overlays,(function(e,s){return i("v-expansion-panel",{key:s},[i("v-expansion-panel-header",[i("v-row",{staticClass:"align-center",attrs:{"no-gutters":""}},[i("v-icon",{staticClass:"mx-2 drag-handle"},[t._v(" mdi-drag-horizontal-variant ")]),i("v-icon",{staticClass:"mx-2",on:{click:function(e){return e.stopPropagation(),t.toggleVisibility(s)}}},[t._v(t._s(t.visibilityIcon(t.overlays_[s].visible)))]),t._v(t._s(e.name)+" ")],1)],1),i("v-expansion-panel-content",[i("v-row",[i("v-select",{attrs:{items:t.colorMaps,label:"Color map"},on:{change:function(e){return t.onColorChange(s)}},model:{value:e.colorMap,callback:function(i){t.$set(e,"colorMap",i)},expression:"overlay.colorMap"}})],1),i("v-row",[i("v-col",{staticClass:"px-4"},[i("p",[t._v("Intensity range")]),i("v-range-slider",{staticClass:"align-center",attrs:{max:e.intensityMax,min:e.intensityMin,"hide-details":""},scopedSlots:t._u([{key:"prepend",fn:function(){return[i("v-text-field",{staticClass:"mt-0 pt-0",staticStyle:{width:"60px"},attrs:{value:e.intensityRange[0],"hide-details":"","single-line":"",type:"number"},on:{input:function(i){return t.$set(e.intensityRange,0,i)}}})]},proxy:!0},{key:"append",fn:function(){return[i("v-text-field",{staticClass:"mt-0 pt-0",staticStyle:{width:"60px"},attrs:{value:e.intensityRange[1],"hide-details":"","single-line":"",type:"number"},on:{input:function(i){return t.$set(e.intensityRange,1,i)}}})]},proxy:!0}],null,!0),model:{value:e.intensityRange,callback:function(i){t.$set(e,"intensityRange",i)},expression:"overlay.intensityRange"}})],1)],1),i("v-row",[i("v-col",[i("p",[t._v("Opacity")]),i("v-slider",{attrs:{step:"0.01",max:"1",min:"0","thumb-label":"",ticks:""},on:{input:function(i){return t.onOpacityChange(s,e.opacity)}},model:{value:e.opacity,callback:function(i){t.$set(e,"opacity",i)},expression:"overlay.opacity"}})],1)],1)],1)],1)})),1)],1)],1)],1)}),r=[],l=i("b76a"),h=i.n(l),c=new s["a"],u={props:{overlays:Array},name:"controls",components:{draggable:h.a},data:function(){return{colorMaps:["gray","Winter","Warm","Plasma","Viridis","Inferno"],eyeIcon:"mdi-eye",overlays_:this.overlays,draggable:!0,opacity:1,overlayVisibilityState:{}}},methods:{toggleVisibility:function(t){if(1!==this.overlays_.length){this.$set(this.overlays_[t],"visible",!this.overlays_[t].visible);var e=this.overlays_[t].visible;e?c.$emit("opacity-change",{volIdx:t,newOpacity:1}):c.$emit("opacity-change",{volIdx:t,newOpacity:0})}},visibilityIcon:function(t){return t?"mdi-eye":"mdi-eye-off"},onColorChange:function(t){console.log(t),c.$emit("colormap-change")},onOpacityChange:function(t,e){c.$emit("opacity-change",{volIdx:t,newOpacity:e})},onAddOverlay:function(){alert("adding overlays in this demo is not implemented yet! :)")}}},d=u,g=(i("a9e0"),i("2877")),p=i("6544"),m=i.n(p),v=i("8336"),f=i("62ad"),y=i("cd55"),x=i("49e2"),T=i("c865"),b=i("0393"),S=i("132d"),E=i("5963"),w=i("0fd9"),_=i("b974"),R=i("ba0d"),P=i("2fa4"),C=i("8654"),D=Object(g["a"])(d,a,r,!1,null,"861f600c",null),A=D.exports;m()(D,{VBtn:v["a"],VCol:f["a"],VExpansionPanel:y["a"],VExpansionPanelContent:x["a"],VExpansionPanelHeader:T["a"],VExpansionPanels:b["a"],VIcon:S["a"],VRangeSlider:E["a"],VRow:w["a"],VSelect:_["a"],VSlider:R["a"],VSpacer:P["a"],VTextField:C["a"]});var M=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"viewer",attrs:{id:"viewer"}},[i("v-dialog",{attrs:{"max-width":"400"},model:{value:t.dialog,callback:function(e){t.dialog=e},expression:"dialog"}},[i("v-color-picker",{attrs:{width:"400",mode:"rgba"},on:{input:t.onCrosshairColorChange},model:{value:t.crosshairColor,callback:function(e){t.crosshairColor=e},expression:"crosshairColor"}})],1),i("v-dialog",{attrs:{"max-width":"400"},model:{value:t.discoMode,callback:function(e){t.discoMode=e},expression:"discoMode"}},[i("v-card",{attrs:{color:"rgba(0, 0, 0, 0.4)"}},[i("v-row",{attrs:{"no-gutters":""}},[i("v-spacer"),i("h2",{staticStyle:{color:"white"}},[t._v("Disco mode")]),i("v-spacer")],1)],1)],1)],1)},k=[],L=i("c8b5"),U=i("8f10"),V={name:"glviewer",props:{overlays:Array,shader:String},created:function(){},data:function(){return{niivue:null,selectedOverlay:0,last2DSliceVal:.5,mouseDown:!1,touchDown:!1,zDown:!1,discoMode:!1,discoModeColorMapTimer:null,discoModeCrosshairTimer:null,scale:1,dialog:!1,crosshairColor:{r:255,g:0,b:0,a:1},colorMaps:["Winter","Warm","Plasma","Viridis","Inferno"],selectedColorMap:"Winter"}},watch:{overlays:{deep:!0,handler:function(){}}},methods:{setNewPos:function(){var t=this.niivue.frac2mm([this.niivue.scene.crosshairPos[0],this.niivue.scene.crosshairPos[1],this.niivue.scene.crosshairPos[2]]);c.$emit("mm-change",t)},onWindowResize:function(){var t=100,e=document.querySelector("#gl"),i=document.querySelector("#viewer");e.width=i.clientWidth,e.height=i.clientHeight,i.getBoundingClientRect().bottom>document.documentElement.clientHeight&&(i.style.height=document.documentElement.clientHeight-t,e.height=document.documentElement.clientHeight-t),this.niivue.drawScene()},onCrosshairColorChange:function(){var t=[this.crosshairColor.r/255,this.crosshairColor.g/255,this.crosshairColor.b/255,this.crosshairColor.a];this.niivue.setCrosshairColor(t)}},mounted:function(){var t=this,e=document.createElement("canvas");e.classList.add("fillParent");var i=document.querySelector("#viewer");e.id="gl",e.width=i.clientWidth,e.height=i.clientHeight,i.appendChild(e);var s=document.querySelector("#gl"),n=s.getContext("webgl2");n?console.log("webgl2 works!"):"undefined"!==typeof WebGL2RenderingContext?alert("your browser appears to support WebGL2 but it might be disabled. Niivue might not work"):alert("your browser has no WebGL2 support, Niivue will not work! If you are using safari, you can enable the developer menu and activate the WebGL2 item under experimental features.");var o=new L(s);o.get("press").set({time:2e3}),o.get("pinch").set({enable:!0}),n.canvas.addEventListener("mousedown",(function(e){e.preventDefault(),t.dialog=!1,t.mouseDown=!0;var i=s.getBoundingClientRect();t.niivue.mouseClick(e.clientX-i.left,e.clientY-i.top),t.niivue.mouseDown(e.clientX-i.left,e.clientY-i.top),t.setNewPos()})),n.canvas.addEventListener("touchstart",(function(e){e.preventDefault(),t.dialog=!1,t.touchDown=!0;var i=s.getBoundingClientRect();t.niivue.mouseClick(e.touches[0].clientX-i.left,e.touches[0].clientY-i.top),t.niivue.mouseDown(e.touches[0].clientX-i.left,e.touches[0].clientY-i.top),t.setNewPos()})),n.canvas.addEventListener("mousemove",(function(e){if(t.mouseDown){var i=s.getBoundingClientRect();t.niivue.mouseClick(e.clientX-i.left,e.clientY-i.top),t.niivue.mouseMove(e.clientX-i.left,e.clientY-i.top),t.setNewPos()}})),n.canvas.addEventListener("touchmove",(function(e){if(t.touchDown&&e.touches.length<2){var i=s.getBoundingClientRect();t.niivue.mouseClick(e.touches[0].clientX-i.left,e.touches[0].clientY-i.top),t.niivue.mouseMove(e.touches[0].clientX-i.left,e.touches[0].clientY-i.top),t.setNewPos()}})),o.on("pinchin",(function(){t.niivue.sliceScroll2D(.001,null,null),t.setNewPos()})),o.on("pinchout",(function(){t.niivue.sliceScroll2D(-.001,null,null),t.setNewPos()})),n.canvas.addEventListener("wheel",(function(e){if(t.zDown)e.preventDefault(),t.scale+=-.01*e.deltaY,t.niivue.setScale(t.scale);else{e.preventDefault(),e.stopPropagation();var i=s.getBoundingClientRect();e.deltaY<0?t.niivue.sliceScroll2D(-.01,e.clientX-i.left,e.clientY-i.top):t.niivue.sliceScroll2D(.01,e.clientX-i.left,e.clientY-i.top),t.setNewPos()}})),o.on("press",(function(){t.dialog=!0})),n.canvas.addEventListener("mouseup",(function(){t.mouseDown=!1})),n.canvas.addEventListener("tocuhend",(function(){t.touchDown=!1})),window.addEventListener("keypress",(function(e){"z"===e.key&&(t.zDown=!0),"d"===e.key&&(t.discoMode=0==t.discoMode,clearInterval(t.discoModeColorMapTimer),clearInterval(t.discoModeCrosshairTimer),t.discoMode?(t.discoModeColorMapTimer=setInterval((function(){c.$emit("colormap-change",t.colorMaps[Math.floor(Math.random()*t.colorMaps.length)])}),200),t.discoModeCrosshairTimer=setInterval((function(){this.niivue.setCrosshairColor([Math.random(),Math.random(),Math.random(),1])}),200)):(c.$emit("colormap-change","gray"),t.niivue.setCrosshairColor([1,0,0,1])))})),window.addEventListener("keyup",(function(e){"z"===e.key&&(t.zDown=!1)})),window.addEventListener("resize",this.onWindowResize),this.niivue=new U["a"]({}).attachTo("#gl"),this.gl=n,this.niivue.loadVolumes(this.overlays),c.$on("opacity-change",(function(e){t.niivue.setOpacity(e.volIdx,e.newOpacity)})),c.$on("slice-type-change",function(t){this.niivue.setSliceType(t)}.bind(this)),c.$on("set-2D-slice",function(t){this.niivue.sliceScroll2D(t,null,null,!1)}.bind(this)),c.$on("set-clip-planes",function(t){this.niivue.clipPlaneUpdate(t)}.bind(this)),c.$on("colormap-change",function(){this.niivue.loadVolumes(this.overlays)}.bind(this)),c.$on("refresh",function(){this.niivue.updateGLVolume(this.overlays)}.bind(this))}},W=V,I=(i("d109"),i("b0af")),F=i("03a4"),N=i("169a"),H=Object(g["a"])(W,M,k,!1,null,"690d447c",null),X=H.exports;m()(H,{VCard:I["a"],VColorPicker:F["a"],VDialog:N["a"],VRow:w["a"],VSpacer:P["a"]});var z={name:"App",components:{controls:A,glviewer:X},created:function(){var t=this;c.$on("mm-change",(function(e){t.coordinateString=e[0].toFixed(2)+"×"+e[1].toFixed(2)+"×"+e[2].toFixed(2)}))},data:function(){return{tab:null,viewShown2D:!1,viewShown3D:!1,clipValAz:0,clipValEl:0,clipValDepth:.5,sliceScrollVal:.5,appTabs:["Menu","Draw","Edit","Scripting"],coordinateString:"0x0x0",overlayList:[{url:"./LAS.nii.gz",volume:{hdr:null,img:null},name:"LAS.nii.gz",intensityMin:0,intensityMax:100,intensityRange:[0,100],colorMap:"gray",opacity:100,visible:!0},{url:"./hippo.nii.gz",volume:{hdr:null,img:null},name:"hippo.nii.gz",intensityMin:0,intensityMax:100,intensityRange:[0,100],colorMap:"Winter",opacity:100,visible:!0}]}},computed:{urlOverlayList:function(){var t=[];if(void 0===this.$route.query.urls||null===this.$route.query.urls||""===this.$route.query.urls)return this.overlayList;for(var e=this.$route.query.urls.split(","),i=0;i<e.length;i++)t.push({url:e[i],volume:{hdr:null,img:null},name:e[i].split("/").pop(),intensityMin:0,intensityMax:100,intensityRange:[0,100],colorMap:"gray",opacity:100,visible:!0});return t.length>0?(c.$emit("refresh"),t):this.overlayList}},methods:{setSliceType:function(t){t<3?(this.viewShown2D=!0,this.viewShown3D=!1):4==t?(this.viewShown2D=!1,this.viewShown3D=!0):(this.viewShown2D=!1,this.viewShown3D=!1),c.$emit("slice-type-change",t)},onSliceSlider2D:function(){this.viewShown2D&&c.$emit("set-2D-slice",this.sliceScrollVal)},onClipPlaneChange:function(){this.viewShown3D&&c.$emit("set-clip-planes",[this.clipValAz,this.clipValEl,this.clipValDepth])},onResetClipPlane:function(){this.viewShown3D&&(this.clipValAz=0,this.clipValEl=0,this.clipValDepth=2,c.$emit("set-clip-planes",[this.clipValAz,this.clipValEl,this.clipValDepth]))}}},O=z,B=i("7496"),G=i("40dc"),$=i("553a"),j=i("f6c4"),Y=i("71d9"),q=Object(g["a"])(O,n,o,!1,null,null,null),K=q.exports;m()(q,{VApp:B["a"],VAppBar:G["a"],VBtn:v["a"],VCol:f["a"],VExpansionPanel:y["a"],VExpansionPanelContent:x["a"],VExpansionPanelHeader:T["a"],VExpansionPanels:b["a"],VFooter:$["a"],VIcon:S["a"],VMain:j["a"],VRow:w["a"],VSlider:R["a"],VSpacer:P["a"],VToolbar:Y["a"]});var Z=i("8c4f"),J=(i("5363"),i("f309"));i("bf40");s["a"].use(J["a"]);var Q=new J["a"]({icons:{iconfont:"mdi"}});s["a"].use(Z["a"]),s["a"].config.productionTip=!1;var tt=new Z["a"]({routes:[],mode:"history"});new s["a"]({vuetify:Q,router:tt,render:function(t){return t(K)}}).$mount("#app")},"8bb8":function(t,e,i){"use strict";i.d(e,"o",(function(){return s})),i.d(e,"i",(function(){return n})),i.d(e,"p",(function(){return o})),i.d(e,"j",(function(){return a})),i.d(e,"c",(function(){return r})),i.d(e,"k",(function(){return l})),i.d(e,"a",(function(){return h})),i.d(e,"m",(function(){return c})),i.d(e,"l",(function(){return u})),i.d(e,"b",(function(){return d})),i.d(e,"n",(function(){return g})),i.d(e,"g",(function(){return p})),i.d(e,"f",(function(){return m})),i.d(e,"e",(function(){return v})),i.d(e,"d",(function(){return f})),i.d(e,"h",(function(){return y}));var s="#version 300 es\n#line 4\nlayout(location=0) in vec3 pos;\nuniform mat4 mvpMtx;\nout vec3 vColor;\nvoid main(void) {\n\tgl_Position = mvpMtx * vec4(2.0 * (pos.xyz - 0.5), 1.0);\n\tvColor = pos;\n}",n="#version 300 es\n#line 15\nprecision highp int;\nprecision highp float;\nuniform vec3 rayDir;\nuniform vec3 texVox;\nuniform vec4 clipPlane;\nuniform highp sampler3D volume, overlay;\nuniform float overlays;\nuniform float backOpacity;\nin vec3 vColor;\nout vec4 fColor;\nvec3 GetBackPosition (vec3 startPosition) {\n vec3 invR = 1.0 / rayDir;\n vec3 tbot = invR * (vec3(0.0)-startPosition);\n vec3 ttop = invR * (vec3(1.0)-startPosition);\n vec3 tmax = max(ttop, tbot);\n vec2 t = min(tmax.xx, tmax.yz);\n return startPosition + (rayDir * min(t.x, t.y));\n}\nvec4 applyClip (vec3 dir, inout vec4 samplePos, inout float len) {\n\tfloat cdot = dot(dir,clipPlane.xyz);\n\tif  ((clipPlane.a > 1.0) || (cdot == 0.0)) return samplePos;\n    bool frontface = (cdot > 0.0);\n\tfloat clipThick = 2.0;\n    float dis = (-clipPlane.a - dot(clipPlane.xyz, samplePos.xyz-0.5)) / cdot;\n    float  disBackFace = (-(clipPlane.a-clipThick) - dot(clipPlane.xyz, samplePos.xyz-0.5)) / cdot;\n    if (((frontface) && (dis >= len)) || ((!frontface) && (dis <= 0.0))) {\n        samplePos.a = len + 1.0;\n        return samplePos;\n    }\n    if (frontface) {\n        dis = max(0.0, dis);\n        samplePos = vec4(samplePos.xyz+dir * dis, dis);\n        len = min(disBackFace, len);\n    }\n    if (!frontface) {\n        len = min(dis, len);\n        disBackFace = max(0.0, disBackFace);\n        samplePos = vec4(samplePos.xyz+dir * disBackFace, disBackFace);\n    }\n    return samplePos;\n}\nvoid main() {\n    fColor = vec4(0.0,0.0,0.0,0.0);\n\tvec3 start = vColor;\n\tvec3 backPosition = GetBackPosition(start);\n\t//fColor = vec4(backPosition, 1.0); return;\n    vec3 dir = backPosition - start;\n    float len = length(dir);\n\tfloat lenVox = length((texVox * start) - (texVox * backPosition));\n\tif (lenVox < 0.5) return;\n\tfloat sliceSize = len / lenVox; //e.g. if ray length is 1.0 and traverses 50 voxels, each voxel is 0.02 in unit cube\n\tfloat stepSize = sliceSize; //quality: larger step is faster traversal, but fewer samples\n\tfloat opacityCorrection = stepSize/sliceSize;\n    dir = normalize(dir);\n\tvec4 deltaDir = vec4(dir.xyz * stepSize, stepSize);\n\tvec4 samplePos = vec4(start.xyz, 0.0); //ray position\n\tfloat lenNoClip = len;\n\tvec4 clipPos = applyClip(dir, samplePos, len);\n\t//start: OPTIONAL fast pass: rapid traversal until first hit\n\tfloat stepSizeFast = sliceSize * 1.9;\n\tvec4 deltaDirFast = vec4(dir.xyz * stepSizeFast, stepSizeFast);\n\twhile (samplePos.a <= len) {\n\t\tfloat val = texture(volume, samplePos.xyz).r;\n\t\tif (val > 0.01) break;\n\t\tsamplePos += deltaDirFast; //advance ray position\n\t}\n\tif ((samplePos.a > len) && (overlays < 1.0)) return;\n\tsamplePos -= deltaDirFast;\n\tif (samplePos.a < 0.0)\n\t\tvec4 samplePos = vec4(start.xyz, 0.0); //ray position\n\t//end: fast pass\n\tvec4 colAcc = vec4(0.0,0.0,0.0,0.0);\n\tconst float earlyTermination = 0.95;\n\tfloat backNearest = len; //assume no hit\n    float ran = fract(sin(gl_FragCoord.x * 12.9898 + gl_FragCoord.y * 78.233) * 43758.5453);\n    samplePos += deltaDir * ran; //jitter ray\n\twhile (samplePos.a <= len) {\n\t\tvec4 colorSample = texture(volume, samplePos.xyz);\n\t\tsamplePos += deltaDir; //advance ray position\n\t\tif (colorSample.a < 0.01) continue;\n\t\tbackNearest = min(backNearest, samplePos.a);\n\t\tcolorSample.a = 1.0-pow((1.0 - colorSample.a), opacityCorrection);\n\t\tcolorSample.rgb *= colorSample.a;\n\t\tcolAcc= (1.0 - colAcc.a) * colorSample + colAcc;\n\t\tif ( colAcc.a > earlyTermination )\n\t\t\tbreak;\n\t}\n\tcolAcc.a = (colAcc.a / earlyTermination) * backOpacity;\n\tfColor = colAcc;\n\tif (overlays < 1.0) return;\n\t//overlay pass\n\tlen = lenNoClip;\n\tsamplePos = vec4(start.xyz, 0.0); //ray position\n    //start: OPTIONAL fast pass: rapid traversal until first hit\n\tstepSizeFast = sliceSize * 1.9;\n\tdeltaDirFast = vec4(dir.xyz * stepSizeFast, stepSizeFast);\n\twhile (samplePos.a <= len) {\n\t\tfloat val = texture(overlay, samplePos.xyz).a;\n\t\tif (val > 0.01) break;\n\t\tsamplePos += deltaDirFast; //advance ray position\n\t}\n\tif (samplePos.a > len) return;\n\tsamplePos -= deltaDirFast;\n\tif (samplePos.a < 0.0)\n\t\tvec4 samplePos = vec4(start.xyz, 0.0); //ray position\n\t//end: fast pass\n\tfloat overFarthest = len;\n\tcolAcc = vec4(0.0, 0.0, 0.0, 0.0);\n\tsamplePos += deltaDir * ran; //jitter ray\n\twhile (samplePos.a <= len) {\n\t\tvec4 colorSample = texture(overlay, samplePos.xyz);\n\t\tsamplePos += deltaDir; //advance ray position\n\t\tif (colorSample.a < 0.01) continue;\n\t\tcolorSample.a = 1.0-pow((1.0 - colorSample.a), opacityCorrection);\n\t\tcolorSample.rgb *= colorSample.a;\n\t\tcolAcc= (1.0 - colAcc.a) * colorSample + colAcc;\n\t\toverFarthest = samplePos.a;\n\t\tif ( colAcc.a > earlyTermination )\n\t\t\tbreak;\n\t}\n\tfloat overMix = colAcc.a;\n\tfloat overlayDepth = 0.3;\n\tif (fColor.a <= 0.0)\n\t\t\toverMix = 1.0;\n\telse if (((overFarthest) > backNearest)) {\n\t\tfloat dx = (overFarthest - backNearest)/1.73;\n\t\tdx = fColor.a * pow(dx, overlayDepth);\n\t\toverMix *= 1.0 - dx;\n\t}\n\tfColor.rgb = mix(fColor.rgb, colAcc.rgb, overMix);\n\tfColor.a = max(fColor.a, colAcc.a);\n}",o="#version 300 es\n#line 150\nlayout(location=0) in vec3 pos;\nuniform int axCorSag;\nuniform float slice;\nuniform vec2 canvasWidthHeight;\nuniform vec4 leftTopWidthHeight;\nout vec3 texPos;\nvoid main(void) {\n\t//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1\n\tvec2 frac;\n\tfrac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1\n\tfrac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0\n\tfrac = (frac * 2.0) - 1.0;\n\tgl_Position = vec4(frac, 0.0, 1.0);\n\tif (axCorSag == 1)\n\t\ttexPos = vec3(pos.x, slice, pos.y);\n\telse if (axCorSag == 2)\n\t\ttexPos = vec3(slice, pos.x, pos.y);\n\telse\n\t\ttexPos = vec3(pos.xy, slice);\n}",a="#version 300 es\n#line 173\nprecision highp int;\nprecision highp float;\nuniform highp sampler3D volume, overlay;\nuniform float opacity;\nin vec3 texPos;\nout vec4 color;\nvoid main() {\n\tcolor = vec4(texture(volume, texPos).rgb, opacity);\n\tvec4 ocolor = texture(overlay, texPos);\n\tcolor.rgb = mix(color.rgb, ocolor.rgb, ocolor.a);\n\tcolor.a = color.a + (ocolor.a * (1.0 - color.a));\n}",r="#version 300 es\n#line 189\nprecision highp int;\nprecision highp float;\nuniform vec4 lineColor;\nout vec4 color;\nvoid main() {\n\tcolor = lineColor;\n}",l="#version 300 es\n#line 200\nlayout(location=0) in vec3 pos;\nuniform vec2 canvasWidthHeight;\nuniform vec4 leftTopWidthHeight;\nout float vColor;\nvoid main(void) {\n\t//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1\n\tvec2 frac;\n\tfrac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1\n\tfrac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0\n\tfrac = (frac * 2.0) - 1.0;\n\tgl_Position = vec4(frac, 0.0, 1.0);\n\tvColor = pos.x;\n}",h="#version 300 es\n#line 217\nprecision highp int;\nprecision highp float;\nuniform highp sampler2D colormap;\nin float vColor;\nout vec4 color;\nvoid main() {\n\tcolor = vec4(texture(colormap, vec2(vColor, 0.5)).rgb, 1.0);\n}",c="#version 300 es\n#line 229\nlayout(location=0) in vec3 pos;\nuniform vec2 canvasWidthHeight;\nuniform vec4 leftTopWidthHeight;\nvoid main(void) {\n\t//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1\n\tvec2 frac;\n\tfrac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1\n\tfrac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0\n\tfrac = (frac * 2.0) - 1.0;\n\tgl_Position = vec4(frac, 0.0, 1.0);\n}",u="#version 300 es\n#line 244\nlayout(location=0) in vec3 pos;\nuniform vec2 canvasWidthHeight;\nuniform vec4 leftTopWidthHeight;\nuniform vec4 uvLeftTopWidthHeight;\nout vec2 vUV;\nvoid main(void) {\n\t//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1\n\tvec2 frac;\n\tfrac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1\n\tfrac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0\n\tfrac = (frac * 2.0) - 1.0;\n\tgl_Position = vec4(frac, 0.0, 1.0);\n\tvUV = vec2(uvLeftTopWidthHeight.x + (pos.x * uvLeftTopWidthHeight.z), uvLeftTopWidthHeight.y  + ((1.0 - pos.y) * uvLeftTopWidthHeight.w) );\n}",d="#version 300 es\n#line 262\nprecision highp int;\nprecision highp float;\nuniform highp sampler2D fontTexture;\nuniform vec4 fontColor;\nuniform float screenPxRange;\nin vec2 vUV;\nout vec4 color;\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\nvoid main() {\n\tvec3 msd = texture(fontTexture, vUV).rgb;\n\tfloat sd = median(msd.r, msd.g, msd.b);\n    float screenPxDistance = screenPxRange*(sd - 0.5);\n    float opacity = clamp(screenPxDistance + 0.5, 0.0, 1.0);\n\tcolor = vec4(fontColor.rgb , fontColor.a * opacity);\n}",g="#version 300 es\n#line 283\nprecision highp int;\nprecision highp float;\nin vec3 vPos;\nout vec2 TexCoord;\nvoid main() {\n    TexCoord = vPos.xy;\n    gl_Position = vec4( (vPos.xy-vec2(0.5,0.5))* 2.0, 0.0, 1.0);\n}",p="#version 300 es\nuniform highp usampler3D intensityVol;\n",m="#version 300 es\nuniform highp isampler3D intensityVol;\n",v="#version 300 es\nuniform highp sampler3D intensityVol;\n",f="#line 309\nprecision highp int;\nprecision highp float;\nin vec2 TexCoord;\nout vec4 FragColor;\nuniform float coordZ;\nuniform float layer;\nuniform float scl_slope;\nuniform float scl_inter;\nuniform float cal_max;\nuniform float cal_min;\nuniform highp sampler2D colormap;\nuniform highp sampler2D in2D;\nuniform float opacity;\nuniform mat4 mtx;\nvoid main(void) {\n vec4 vx = vec4(TexCoord.xy, coordZ, 1.0) * mtx;\n float f = (scl_slope * float(texture(intensityVol, vx.xyz).r)) + scl_inter;\n float r = max(0.00001, abs(cal_max - cal_min));\n float mn = min(cal_min, cal_max);\n f = mix(0.0, 1.0, (f - mn) / r);\n FragColor = texture(colormap, vec2(f, 0.5)).rgba;\n FragColor.a *= opacity;\n if (layer < 2.0) return;\n vec4 prevColor = texture(in2D, TexCoord);\n FragColor.rgb = mix(FragColor.rgb, prevColor.rgb, FragColor.a);\n FragColor.a += ((1.0 - FragColor.a) * prevColor.a);\n}",y="#version 300 es\nprecision highp int;\nprecision highp float;\nin vec2 TexCoord;\nout vec4 FragColor;\nuniform float coordZ;\nuniform highp sampler3D in3D;\nvoid main(void) {\n //FragColor = texture(in3D, vec3(TexCoord.xy, coordZ));\n FragColor = vec4(TexCoord.x, TexCoord.y, 1.0, 0.9);\n}"},"8f10":function(t,e,i){"use strict";(function(t){i.d(e,"a",(function(){return l}));var s=i("1da1"),n=(i("96cf"),i("8a59"),i("9a8c"),i("a975"),i("735e"),i("c1ac"),i("d139"),i("3a7b"),i("d5d6"),i("82f8"),i("e91f"),i("60bd"),i("5f96"),i("3280"),i("3fcc"),i("ca91"),i("25a1"),i("cd26"),i("3c5d"),i("2954"),i("649e"),i("219c"),i("170b"),i("b39a"),i("72f7"),i("d3b7"),i("fb6a"),i("5cc6"),i("cfc3"),i("99af"),i("8b09"),i("4a9b"),i("84c3"),i("20bf"),i("b680"),i("0037")),o=i("5243"),a=i("20e7"),r=i("8bb8"),l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var e in this.opts={},this.defaults={textHeight:.03,colorbarHeight:.05,crosshairWidth:1,backColor:[0,0,0,1],crosshairColor:[1,0,0,1],colorBarMargin:.05},this.gl=null,this.colormapTexture=null,this.volumeTexture=null,this.overlayTexture=null,this.sliceShader=null,this.lineShader=null,this.renderShader=null,this.colorbarShader=null,this.fontShader=null,this.passThroughShader=null,this.orientShaderU=null,this.orientShaderI=null,this.orientShaderF=null,this.fontMets=null,this.sliceTypeAxial=0,this.sliceTypeCoronal=1,this.sliceTypeSagittal=2,this.sliceTypeMultiplanar=3,this.sliceTypeRender=4,this.sliceType=this.sliceTypeMultiplanar,this.scene={},this.scene.renderAzimuth=120,this.scene.renderElevation=15,this.scene.crosshairPos=[.5,.5,.5],this.scene.clipPlane=[0,0,0,0],this.back={},this.overlays=[],this.volumes=[],this.backTexture=[],this.isRadiologicalConvention=!1,this.volScaleMultiplier=1,this.mousePos=[0,0],this.numScreenSlices=0,this.screenSlices=[{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial}],this.backOpacity=1,this.defaults)this.opts[e]=void 0===t[e]?this.defaults[e]:t[e]};function h(t,e){return 0===t.scl_slope&&(t.scl_slope=1),e*t.scl_slope+t.scl_inter}l.prototype.arrayEquals=function(t,e){return Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((function(t,i){return t===e[i]}))},l.prototype.mouseDown=function(t,e){this.sliceType==this.sliceTypeRender&&(this.mousePos=[t,e])},l.prototype.mouseMove=function(t,e){this.sliceType==this.sliceTypeRender&&(this.scene.renderAzimuth+=t-this.mousePos[0],this.scene.renderElevation+=e-this.mousePos[1],this.mousePos=[t,e],this.drawScene())},l.prototype.sph2cartDeg=function(t,e){var i=-e*(Math.PI/180),s=(t-90)%360*(Math.PI/180),n=[Math.cos(i)*Math.cos(s),Math.cos(i)*Math.sin(s),Math.sin(i)],o=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);return o<=0||(n[0]/=o,n[1]/=o,n[2]/=o),n},l.prototype.clipPlaneUpdate=function(t){if(this.sliceType==this.sliceTypeRender){var e=this.sph2cartDeg(t[0],t[1]);this.scene.clipPlane=[e[0],e[1],e[2],t[2]],this.drawScene()}},l.prototype.setCrosshairColor=function(t){this.opts.crosshairColor=t,this.drawScene()},l.prototype.sliceScroll2D=function(t,e,i){var s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this.mouseClick(e,i,t,s)},l.prototype.setSliceType=function(t){this.sliceType=t,this.drawScene()},l.prototype.setOpacity=function(t,e){if(this.volumes[t].opacity=e,0===t)return this.backOpacity=e,void this.drawScene();this.updateGLVolume()},l.prototype.setScale=function(t){this.volScaleMultiplier=t,this.drawScene()},l.prototype.attachTo=function(t){return this.gl=document.querySelector(t).getContext("webgl2"),this.gl||(alert("unable to get webgl2 context. Perhaps this browser does not support webgl2"),console.log("unable to get webgl2 context. Perhaps this browser does not support webgl2")),this.init(),this},l.prototype.overlayRGBA=function(t){for(var e=t.hdr,i=e.dims[1]*e.dims[2]*e.dims[3],s=new Uint8ClampedArray(4*i),n=.2*Math.min(Math.min(e.dims[1],e.dims[2]),e.dims[3]),o=.5*e.dims[1],a=.5*e.dims[2],r=.5*e.dims[3],l=0,h=0;h<e.dims[3];h++)for(var c=0;c<e.dims[2];c++)for(var u=0;u<e.dims[1];u++){var d=Math.abs(u-o),g=Math.abs(c-a),p=Math.abs(h-r),m=Math.sqrt(d*d+g*g+p*p),v=0;m<n&&(v=255),s[l++]=0,s[l++]=v,s[l++]=0,s[l++]=.5*v}return s},l.prototype.vox2mm=function(t,e){var i=a["b"].clone(e);a["b"].transpose(i,i);var s=a["d"].fromValues(t[0],t[1],t[2],1);a["d"].transformMat4(s,s,i);var n=a["c"].fromValues(s[0],s[1],s[2]);return n},l.prototype.nii2RAS=function(t){var e=t.volume.hdr,i=e.affine,s=a["a"].fromValues(Math.abs(i[0][0]),Math.abs(i[0][1]),Math.abs(i[0][2]),Math.abs(i[1][0]),Math.abs(i[1][1]),Math.abs(i[1][2]),Math.abs(i[2][0]),Math.abs(i[2][1]),Math.abs(i[2][2])),n=[1,1,1];s[3]>s[0]&&(n[0]=2),s[6]>s[0]&&s[6]>s[3]&&(n[0]=3),n[1]=1,1===n[0]?s[4]>s[7]?n[1]=2:n[1]=3:2===n[0]?s[1]>s[7]?n[1]=1:n[1]=3:s[1]>s[4]?n[1]=1:n[1]=2,n[2]=6-n[1]-n[0];var o=[1,2,3];o[n[0]-1]=1,o[n[1]-1]=2,o[n[2]-1]=3;var r=a["b"].fromValues(i[0][0],i[0][1],i[0][2],i[0][3],i[1][0],i[1][1],i[1][2],i[1][3],i[2][0],i[2][1],i[2][2],i[2][3],0,0,0,1);t.mm000=this.vox2mm([-.5,-.5,-.5],r),t.mm100=this.vox2mm([e.dims[1]-.5,-.5,-.5],r),t.mm010=this.vox2mm([-.5,e.dims[2]-.5,-.5],r),t.mm001=this.vox2mm([-.5,-.5,e.dims[3]-.5],r);var l=a["b"].create();a["b"].copy(l,r);for(var h=0;h<3;h++)for(var c=0;c<3;c++)l[4*h+c]=r[4*h+o[c]-1];var u=[0,0,0];if(l[0]<0&&(u[0]=1),l[5]<0&&(u[1]=1),l[10]<0&&(u[2]=1),t.dimsRAS=[e.dims[0],e.dims[o[0]],e.dims[o[1]],e.dims[o[2]]],t.pixDimsRAS=[e.pixDims[0],e.pixDims[o[0]],e.pixDims[o[1]],e.pixDims[o[2]]],this.arrayEquals(o,[1,2,3])&&this.arrayEquals(u,[0,0,0]))return t.toRAS=a["b"].create(),void(t.matRAS=a["b"].clone(r));a["b"].identity(r),r[0]=1-2*u[0],r[5]=1-2*u[1],r[10]=1-2*u[2],r[3]=(e.dims[o[0]]-1)*u[0],r[7]=(e.dims[o[1]]-1)*u[1],r[11]=(e.dims[o[2]]-1)*u[2];var d=a["b"].create();a["b"].invert(d,r),a["b"].multiply(d,d,l),t.matRAS=a["b"].clone(d),r=a["b"].fromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),r[o[0]-1+0]=2*-u[0]+1,r[o[1]-1+4]=2*-u[1]+1,r[o[2]-1+8]=2*-u[2]+1,r[3]=u[0],r[7]=u[1],r[11]=u[2],t.toRAS=a["b"].clone(r)},l.prototype.loadVolumes=function(t){var e=this;this.volumes=t,this.back=this.volumes[0],this.overlays=this.volumes.slice(1);for(var i=[],s=null,o=null,a=function(a){console.log("loading ",t[a].url);var r=e.volumes[a].url;i.push(new XMLHttpRequest),i[a].open("GET",r,!0),i[a].responseType="arraybuffer",i[a].onerror=function(){console.error("error loading volume ",this.volumes[a].url),alert("error loading "+this.volumes[a].url)},i[a].onload=function(){var t=i[a].response;s=null,o=null,t?(s=n["readHeader"](t),o=n["isCompressed"](t)?n["readImage"](s,n["decompress"](t)):n["readImage"](s,t)):(alert("Unable to load buffer properly from volume?"),console.log("no buffer?")),this.volumes[a].volume={},this.volumes[a].volume.hdr=s,this.volumes[a].volume.img=o,this.volumes[a].opacity=1,this.nii2RAS(this.volumes[a]),this.selectColormap(this.volumes[0].colorMap),this.updateGLVolume()}.bind(e),i[a].send()},r=0;r<t.length;r++)a(r);return this},l.prototype.rgbaTex=function(t,e,i){var s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(t&&this.gl.deleteTexture(t),t=this.gl.createTexture(),this.gl.activeTexture(e),this.gl.bindTexture(this.gl.TEXTURE_3D,t),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.RGBA8,i[1],i[2],i[3]),s){var n=new Uint8Array(i[1]*i[2]*i[3]*4);this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,i[1],i[2],i[3],this.gl.RGBA,this.gl.UNSIGNED_BYTE,n)}return t},l.prototype.loadPng=function(t){var e=null;e=new Image,e.onload=function(){var t=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE3),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e)}.bind(this),e.src=t},l.prototype.initText=Object(s["a"])(regeneratorRuntime.mark((function t(){var e,i,n,o,a,r,l,h,c,u,d,g,p;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return o=function(){return o=Object(s["a"])(regeneratorRuntime.mark((function t(){var e;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,fetch("./fnt.json");case 2:return e=t.sent,t.next=5,e.json();case 5:i=t.sent;case 6:case"end":return t.stop()}}),t)}))),o.apply(this,arguments)},n=function(){return o.apply(this,arguments)},t.next=4,this.loadPng("fnt.png");case 4:for(this.fontMets=[],e=0;e<256;e++)this.fontMets[e]={},this.fontMets[e].xadv=0,this.fontMets[e].uv_lbwh=[0,0,0,0],this.fontMets[e].lbwh=[0,0,0,0];return i=[],t.next=9,n();case 9:this.fontMets.distanceRange=i.atlas.distanceRange,this.fontMets.size=i.atlas.size,a=i.atlas.width,r=i.atlas.height,l=0;case 14:if(!(l<i.glyphs.length)){t.next=33;break}if(h=i.glyphs[l],c=h.unicode,this.fontMets[c].xadv=h.advance,void 0!==h.planeBounds){t.next=20;break}return t.abrupt("continue",30);case 20:u=h.atlasBounds.left/a,d=(r-h.atlasBounds.top)/r,g=(h.atlasBounds.right-h.atlasBounds.left)/a,p=(h.atlasBounds.top-h.atlasBounds.bottom)/r,this.fontMets[c].uv_lbwh=[u,d,g,p],u=h.planeBounds.left,d=h.planeBounds.bottom,g=h.planeBounds.right-h.planeBounds.left,p=h.planeBounds.top-h.planeBounds.bottom,this.fontMets[c].lbwh=[u,d,g,p];case 30:l++,t.next=14;break;case 33:case"end":return t.stop()}}),t,this)}))),l.prototype.init=Object(s["a"])(regeneratorRuntime.mark((function t(){var e,i,s,n,a,l;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e=this.gl.getExtension("WEBGL_debug_renderer_info"),i=this.gl.getParameter(e.UNMASKED_VENDOR_WEBGL),s=this.gl.getParameter(e.UNMASKED_RENDERER_WEBGL),console.log("gpu vendor: ",i),console.log("gpu renderer: ",s),this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.FRONT),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.rgbaTex(this.volumeTexture,this.gl.TEXTURE0,[2,2,2,2],!0),this.rgbaTex(this.overlayTexture,this.gl.TEXTURE2,[2,2,2,2],!0),n=[0,1,0,1,1,0,0,1,1,1,1,1,1,0,1,1,1,0,1,0,0,0,1,0,0,0,0,0,1,1,0,0,1,1,0,1,0,0,0,1,0,0],a=this.gl.createVertexArray(),this.gl.bindVertexArray(a),l=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(n),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(0),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),this.sliceShader=new o["a"](this.gl,r["p"],r["j"]),this.sliceShader.use(this.gl),this.gl.uniform1i(this.sliceShader.uniforms["volume"],0),this.gl.uniform1i(this.sliceShader.uniforms["colormap"],1),this.gl.uniform1i(this.sliceShader.uniforms["overlay"],2),this.lineShader=new o["a"](this.gl,r["m"],r["c"]),this.renderShader=new o["a"](this.gl,r["o"],r["i"]),this.renderShader.use(this.gl),this.gl.uniform1i(this.renderShader.uniforms["volume"],0),this.gl.uniform1i(this.renderShader.uniforms["colormap"],1),this.gl.uniform1i(this.renderShader.uniforms["overlay"],2),this.colorbarShader=new o["a"](this.gl,r["k"],r["a"]),this.colorbarShader.use(this.gl),this.gl.uniform1i(this.colorbarShader.uniforms["colormap"],1),this.fontShader=new o["a"](this.gl,r["l"],r["b"]),this.fontShader.use(this.gl),this.gl.uniform1i(this.fontShader.uniforms["fontTexture"],3),this.passThroughShader=new o["a"](this.gl,r["n"],r["h"]),this.orientShaderU=new o["a"](this.gl,r["n"],r["g"].concat(r["d"])),this.orientShaderI=new o["a"](this.gl,r["n"],r["f"].concat(r["d"])),this.orientShaderF=new o["a"](this.gl,r["n"],r["e"].concat(r["d"])),t.next=42,this.initText();case 42:return t.abrupt("return",this);case 43:case"end":return t.stop()}}),t,this)}))),l.prototype.updateGLVolume=function(){for(var t=0,e=0;e<this.volumes.length;e++)this.volumes[e].toRAS&&(this.refreshLayers(this.volumes[e],t),t++);this.drawScene()},l.prototype.calMinMaxCore=function(t,e){var i,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.02,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=t.volume.hdr;2===o.datatypeCode?i=new Uint8Array(e):4===o.datatypeCode?i=new Int16Array(e):16===o.datatypeCode?i=new Float32Array(e):64===o.datatypeCode?i=new Float64Array(e):512===o.datatypeCode&&(i=new Uint16Array(e));for(var a=e[0],r=e[0],l=0,c=0,u=i.length,d=0;d<u;d++)isNaN(i[d])?c++:0!==i[d]?(a=Math.min(i[d],a),r=Math.max(i[d],r)):l++;var g=h(o,a),p=h(o,r);n||(l=0),l+=c;var m=Math.round((u-l)*s);if(m<1||a===r)return console.log("no variability in image intensity?"),[g,p,g,p];for(var v=1001,f=(v-1)/(r-a),y=new Array(v),x=0;x<v;x++)y[x]=0;if(n)for(var T=0;T<=u;T++)0!==i[T]&&(isNaN(i[T])||y[(i[T]-a)*f]++);else for(var b=0;b<=u;b++)isNaN(i[b])||y[(i[b]-a)*f]++;var S=0,E=0;while(S<m)S+=y[E],E++;E--,S=0;var w=v;while(S<m)w--,S+=y[w];if(E==w){var _=-1;while(0!==_)E>0&&(E--,y[E]>0&&(_=0)),0!=_&&w<v-1&&(w++,y[w]>0&&(_=0)),0==E&&w==v-1&&(_=0)}var R=h(o,E/f+a),P=h(o,w/f+a);return console.log("full range %f..%f  (voxels 0 or NaN = %i) robust range %f..%f",g,p,l,R,P),t.volume.hdr.cal_min<t.volume.hdr.cal_max&&t.volume.hdr.cal_min>=g&&t.volume.hdr.cal_max<=p&&(console.log("ignoring robust range: using header cal_min and cal_max"),R=t.volume.hdr.cal_min,P=t.volume.hdr.cal_max),[R,P,g,p]},l.prototype.calMinMax=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.02,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=this.calMinMaxCore(t,e,i,s);console.log("cal_min, cal_max, global_min, global_max",n[0],n[1],n[2],n[3]),t.cal_min=n[0],t.cal_max=n[1],t.global_min=n[2],t.global_max=n[3]},l.prototype.refreshLayers=function(t,e){var i,s=t.volume.hdr,n=t.volume.img,o=t.opacity,r=null,l=[];if(0===e)this.back={},l=t.toRAS,o=1,this.back.matRAS=t.matRAS,this.back.dims=t.dimsRAS,this.back.pixDims=t.pixDimsRAS,r=this.rgbaTex(this.volumeTexture,this.gl.TEXTURE0,t.dimsRAS);else{void 0===this.back.dims&&console.log("Fatal error: Unable to render overlay: background dimensions not defined!");var h=this.mm2frac(t.mm000),c=this.mm2frac(t.mm100),u=this.mm2frac(t.mm010),d=this.mm2frac(t.mm001);c=a["c"].subtract(c,c,h),u=a["c"].subtract(u,u,h),d=a["c"].subtract(d,d,h),l=a["b"].fromValues(c[0],c[1],c[2],h[0],u[0],u[1],u[2],h[1],d[0],d[1],d[2],h[2],0,0,0,1),a["b"].invert(l,l),1===e?(r=this.rgbaTex(this.overlayTexture,this.gl.TEXTURE2,this.back.dims),this.backTexture=r):r=this.backTexture}var g=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,g),this.gl.disable(this.gl.CULL_FACE),this.gl.viewport(0,0,this.back.dims[1],this.back.dims[2]),this.gl.disable(this.gl.BLEND);var p=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE6),this.gl.bindTexture(this.gl.TEXTURE_3D,p),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1);var m=this.orientShaderU;if(2===s.datatypeCode)i=new Uint8Array(n),this.gl.texStorage3D(this.gl.TEXTURE_3D,6,this.gl.R8UI,s.dims[1],s.dims[2],s.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,s.dims[1],s.dims[2],s.dims[3],this.gl.RED_INTEGER,this.gl.UNSIGNED_BYTE,i);else if(4===s.datatypeCode)i=new Int16Array(n),this.gl.texStorage3D(this.gl.TEXTURE_3D,6,this.gl.R16I,s.dims[1],s.dims[2],s.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,s.dims[1],s.dims[2],s.dims[3],this.gl.RED_INTEGER,this.gl.SHORT,i),m=this.orientShaderI;else if(16===s.datatypeCode)i=new Float32Array(n),this.gl.texStorage3D(this.gl.TEXTURE_3D,6,this.gl.R32F,s.dims[1],s.dims[2],s.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,s.dims[1],s.dims[2],s.dims[3],this.gl.RED,this.gl.FLOAT,i),m=this.orientShaderF;else if(64===s.datatypeCode){i=new Float64Array(n);var v=new Float32Array;v=Float32Array.from(i),this.gl.texStorage3D(this.gl.TEXTURE_3D,6,this.gl.R32F,s.dims[1],s.dims[2],s.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,s.dims[1],s.dims[2],s.dims[3],this.gl.RED,this.gl.FLOAT,v),m=this.orientShaderF}else 512===s.datatypeCode&&(i=new Uint16Array(n),this.gl.texStorage3D(this.gl.TEXTURE_3D,6,this.gl.R16UI,s.dims[1],s.dims[2],s.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,s.dims[1],s.dims[2],s.dims[3],this.gl.RED_INTEGER,this.gl.UNSIGNED_SHORT,i));void 0===t.global_min&&this.calMinMax(t,i);var f=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE7),this.gl.bindTexture(this.gl.TEXTURE_2D,f),this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,s.dims[1],s.dims[2]),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1);var y=this.passThroughShader;y.use(this.gl),this.gl.uniform1i(y.uniforms["in3D"],2),m.use(this.gl),this.selectColormap(t.colorMap),this.gl.uniform1f(m.uniforms["cal_min"],t.cal_min),this.gl.uniform1f(m.uniforms["cal_max"],t.cal_max),this.gl.bindTexture(this.gl.TEXTURE_3D,p),this.gl.uniform1i(m.uniforms["intensityVol"],6),this.gl.uniform1i(m.uniforms["in2D"],7),this.gl.uniform1i(m.uniforms["colormap"],1),this.gl.uniform1f(m.uniforms["layer"],e),this.gl.uniform1f(m.uniforms["scl_inter"],s.scl_inter),this.gl.uniform1f(m.uniforms["scl_slope"],s.scl_slope),this.gl.uniform1f(m.uniforms["opacity"],o),this.gl.uniformMatrix4fv(m.uniforms["mtx"],!1,l);for(var x=0;x<this.back.dims[3];x++){var T=1/this.back.dims[3]*(x+.5);e>1&&(y.use(this.gl),this.gl.uniform1f(y.uniforms["coordZ"],T),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,f,0),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),m.use(this.gl)),this.gl.uniform1f(m.uniforms["coordZ"],T),this.gl.framebufferTextureLayer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,r,0,x),e<=1&&this.gl.clear(this.gl.DEPTH_BUFFER_BIT),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)}this.gl.deleteTexture(p),this.gl.deleteTexture(f),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.deleteFramebuffer(g)},l.prototype.selectColormap=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=this.makeLut([0,255],[0,255],[0,255],[0,128],[0,255]);return"Winter"===t&&(e=this.makeLut([0,0,0],[0,128,255],[255,196,128],[0,64,128],[0,128,255])),"Warm"===t&&(e=this.makeLut([255,255,255],[127,196,254],[0,0,0],[0,64,128],[0,128,255])),"Plasma"===t&&(e=this.makeLut([13,156,237,240],[8,23,121,249],[135,158,83,33],[0,56,80,88],[0,64,192,255])),"Viridis"===t&&(e=this.makeLut([68,49,53,253],[1,104,183,231],[84,142,121,37],[0,56,80,88],[0,65,192,255])),"Inferno"===t&&(e=this.makeLut([0,120,237,240],[0,28,105,249],[4,109,37,33],[0,56,80,88],[0,64,192,255])),null!==this.colormapTexture&&this.gl.deleteTexture(this.colormapTexture),this.colormapTexture=this.gl.createTexture(),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colormapTexture),this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,256,1),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,256,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this},l.prototype.makeLut=function(t,e,i,s,n){for(var o=new Uint8ClampedArray(1024),a=0;a<n.length-1;a++)for(var r=n[a],l=n[a+1],h=l-r,c=4*r,u=r;u<=l;u++){var d=(u-r)/h;o[c++]=t[a]+d*(t[a+1]-t[a]),o[c++]=e[a]+d*(e[a+1]-e[a]),o[c++]=i[a]+d*(i[a+1]-i[a]),o[c++]=s[a]+d*(s[a+1]-s[a])}return o},l.prototype.sliceScale=function(){var t=[1,this.back.dims[1]*this.back.pixDims[1],this.back.dims[2]*this.back.pixDims[2],this.back.dims[3]*this.back.pixDims[3]],e=Math.max(t[1],Math.max(t[2],t[3])),i=[t[1]/e,t[2]/e,t[3]/e],s=[this.back.dims[1],this.back.dims[2],this.back.dims[3]];return{volScale:i,vox:s}},l.prototype.mouseClick=function(t,e){var i,s,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(this.sliceType===this.sliceTypeRender){if(0===n)return;return n>0&&(this.volScaleMultiplier=Math.min(2,1.1*this.volScaleMultiplier)),n<0&&(this.volScaleMultiplier=Math.max(.5,.9*this.volScaleMultiplier)),void this.drawScene()}if(!(this.numScreenSlices<1||this.gl.canvas.height<1||this.gl.canvas.width<1))for(var a=0;a<this.numScreenSlices;a++){var r=this.screenSlices[a].axCorSag;if(!(r>this.sliceTypeSagittal)){var l=this.screenSlices[a].leftTopWidthHeight,h=!1;l[2]<0&&(h=!0,l[0]+=l[2],l[2]=-l[2]);var c=(t-l[0])/l[2];h&&(c=1-c);var u=1-(e-l[1])/l[3];if(c>=0&&c<1&&u>=0&&u<1)return o?0!==n?(i=this.scene.crosshairPos[2-r],s=i+n,s>1&&(s=1),s<0&&(s=0),this.scene.crosshairPos[2-r]=s,void this.drawScene()):(r===this.sliceTypeAxial&&(this.scene.crosshairPos[0]=c,this.scene.crosshairPos[1]=u),r===this.sliceTypeCoronal&&(this.scene.crosshairPos[0]=c,this.scene.crosshairPos[2]=u),r===this.sliceTypeSagittal&&(this.scene.crosshairPos[1]=c,this.scene.crosshairPos[2]=u),void this.drawScene()):(this.scene.crosshairPos[2-r]=n,void this.drawScene());if(null===t&&null===e)return this.scene.crosshairPos[2-r]=n,void this.drawScene()}}},l.prototype.drawColorbar=function(t){if(!(t[2]<=0||t[3]<=0)){if(this.opts.crosshairWidth>0){this.lineShader.use(this.gl),this.gl.uniform4fv(this.lineShader.uniforms["lineColor"],this.opts.crosshairColor),this.gl.uniform2fv(this.lineShader.uniforms["canvasWidthHeight"],[this.gl.canvas.width,this.gl.canvas.height]);var e=[t[0]-1,t[1]-1,t[2]+2,t[3]+2];this.gl.uniform4f(this.lineShader.uniforms["leftTopWidthHeight"],e[0],e[1],e[2],e[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)}this.colorbarShader.use(this.gl),this.gl.uniform2fv(this.colorbarShader.uniforms["canvasWidthHeight"],[this.gl.canvas.width,this.gl.canvas.height]),this.gl.uniform4f(this.colorbarShader.uniforms["leftTopWidthHeight"],t[0],t[1],t[2],t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)}},l.prototype.textWidth=function(e,i){for(var s=0,n=new t(i),o=0;o<i.length;o++)s+=e*this.fontMets[n[o]].xadv;return s},l.prototype.drawChar=function(t,e,i){var s=this.fontMets[i],n=t[0]+e*s.lbwh[0],o=-e*s.lbwh[1],a=e*s.lbwh[2],r=e*s.lbwh[3],l=t[1]+(o-r)+e;return this.gl.uniform4f(this.fontShader.uniforms["leftTopWidthHeight"],n,l,a,r),this.gl.uniform4fv(this.fontShader.uniforms["uvLeftTopWidthHeight"],s.uv_lbwh),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),e*s.xadv},l.prototype.drawText=function(e,i){if(!(this.opts.textHeight<=0)){this.fontShader.use(this.gl);var s=this.opts.textHeight*this.gl.canvas.height;this.gl.enable(this.gl.BLEND),this.gl.uniform2f(this.fontShader.uniforms["canvasWidthHeight"],this.gl.canvas.width,this.gl.canvas.height),this.gl.uniform4fv(this.fontShader.uniforms["fontColor"],this.opts.crosshairColor);var n=s/this.fontMets.size*this.fontMets.distanceRange;n=Math.max(n,1),this.gl.uniform1f(this.fontShader.uniforms["screenPxRange"],n);for(var o=new t(i),a=0;a<i.length;a++)e[0]+=this.drawChar(e,s,o[a])}},l.prototype.drawTextRight=function(t,e){this.opts.textHeight<=0||(this.fontShader.use(this.gl),t[1]-=.5*this.opts.textHeight*this.gl.canvas.height,this.drawText(t,e))},l.prototype.drawTextBelow=function(t,e){if(!(this.opts.textHeight<=0)){this.fontShader.use(this.gl);var i=this.opts.textHeight*this.gl.canvas.height;t[0]-=.5*this.textWidth(i,e),this.drawText(t,e)}},l.prototype.draw2D=function(t,e){var i=[this.scene.crosshairPos[0],this.scene.crosshairPos[1],this.scene.crosshairPos[2]];e===this.sliceTypeCoronal&&(i=[this.scene.crosshairPos[0],this.scene.crosshairPos[2],this.scene.crosshairPos[1]]),e===this.sliceTypeSagittal&&(i=[this.scene.crosshairPos[1],this.scene.crosshairPos[2],this.scene.crosshairPos[0]]);var s=this.isRadiologicalConvention&&e<this.sliceTypeSagittal;if(this.sliceShader.use(this.gl),this.gl.uniform1f(this.sliceShader.uniforms["opacity"],this.backOpacity),this.gl.uniform1i(this.sliceShader.uniforms["axCorSag"],e),this.gl.uniform1f(this.sliceShader.uniforms["slice"],i[2]),this.gl.uniform2fv(this.sliceShader.uniforms["canvasWidthHeight"],[this.gl.canvas.width,this.gl.canvas.height]),s&&(this.gl.disable(this.gl.CULL_FACE),t[2]=-t[2],t[0]=t[0]-t[2]),this.gl.uniform4f(this.sliceShader.uniforms["leftTopWidthHeight"],t[0],t[1],t[2],t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),this.screenSlices[this.numScreenSlices].leftTopWidthHeight=t,this.screenSlices[this.numScreenSlices].axCorSag=e,this.numScreenSlices+=1,!(this.opts.crosshairWidth<=0)){this.lineShader.use(this.gl),this.gl.uniform4fv(this.lineShader.uniforms["lineColor"],this.opts.crosshairColor),this.gl.uniform2fv(this.lineShader.uniforms["canvasWidthHeight"],[this.gl.canvas.width,this.gl.canvas.height]);var n=t[0]+t[2]*i[0];this.gl.uniform4f(this.lineShader.uniforms["leftTopWidthHeight"],n-.5*this.opts.crosshairWidth,t[1],this.opts.crosshairWidth,t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4);var o=t[1]+t[3]*(1-i[1]);this.gl.uniform4f(this.lineShader.uniforms["leftTopWidthHeight"],t[0],o-.5*this.opts.crosshairWidth,t[2],this.opts.crosshairWidth),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),this.gl.enable(this.gl.CULL_FACE),s?this.drawTextRight([t[0]+t[2]+1,t[1]+.5*t[3]],"R"):e<this.sliceTypeSagittal&&this.drawTextRight([t[0]+1,t[1]+.5*t[3]],"L"),e===this.sliceTypeAxial&&this.drawTextBelow([t[0]+.5*t[2],t[1]+1],"A"),e>this.sliceTypeAxial&&this.drawTextBelow([t[0]+.5*t[2],t[1]+1],"S")}},l.prototype.draw3D=function(){var t=this.sliceScale(),e=t.volScale,i=t.vox;this.renderShader.use(this.gl);var s=Math.min(this.gl.canvas.width,this.gl.canvas.height);if(!(s<=0)){s*=this.volScaleMultiplier;var n=this.gl.canvas.width/2,o=this.gl.canvas.height/2,r=s,l=s;this.gl.viewport(n-.5*r,o-.5*l,r,l),this.gl.clearColor(.2,0,0,1);var h=a["b"].create(),c=-.54;a["b"].translate(h,h,[0,0,c]);var u=(90-this.scene.renderElevation-e[0])*Math.PI/180;a["b"].rotate(h,h,u,[-1,0,0]),u=this.scene.renderAzimuth*Math.PI/180,a["b"].rotate(h,h,u,[0,0,1]),a["b"].scale(h,h,e),a["b"].scale(h,h,[.57,.57,.57]);var d=a["b"].create();a["b"].invert(d,h);var g=a["d"].fromValues(0,0,-1,1);a["d"].transformMat4(g,g,d);var p=a["c"].fromValues(g[0],g[1],g[2]);a["c"].normalize(p,p);var m=1e-5;Math.abs(p[0])<m&&(p[0]=m),Math.abs(p[1])<m&&(p[1]=m),Math.abs(p[2])<m&&(p[2]=m),this.gl.enable(this.gl.CULL_FACE),this.gl.uniformMatrix4fv(this.renderShader.uniforms["mvpMtx"],!1,h),this.gl.uniform1f(this.renderShader.uniforms["overlays"],this.overlays),this.gl.uniform1f(this.renderShader.uniforms["backOpacity"],this.volumes[0].opacity),this.gl.uniform4fv(this.renderShader.uniforms["clipPlane"],this.scene.clipPlane),this.gl.uniform3fv(this.renderShader.uniforms["rayDir"],p),this.gl.uniform3fv(this.renderShader.uniforms["texVox"],i),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,14);var v="azimuth: "+this.scene.renderAzimuth.toFixed(0)+" elevation: "+this.scene.renderElevation.toFixed(0);return v}},l.prototype.mm2frac=function(t){var e=a["d"].fromValues(t[0],t[1],t[2],1),i=this.back.dims,s=[0,0,0];if(i[1]<1||i[2]<1||i[3]<1)return s;var n=a["b"].clone(this.back.matRAS);return a["b"].transpose(n,n),a["b"].invert(n,n),a["d"].transformMat4(e,e,n),s[0]=(e[0]+.5)/i[1],s[1]=(e[1]+.5)/i[2],s[2]=(e[2]+.5)/i[3],s},l.prototype.vox2frac=function(t){var e=[(t[0]+.5)/this.back.dims[1],(t[1]+.5)/this.back.dims[2],(t[2]+.5)/this.back.dims[3]];return e},l.prototype.frac2vox=function(t){var e=[t[0]*this.back.dims[1]-.5,t[1]*this.back.dims[2]-.5,t[2]*this.back.dims[3]-.5];return e},l.prototype.frac2mm=function(t){var e=a["d"].fromValues(t[0],t[1],t[2],1),i=a["d"].fromValues(this.back.dims[1],this.back.dims[2],this.back.dims[3],1),s=a["b"].clone(this.back.matRAS);a["b"].transpose(s,s),a["d"].mul(e,e,i);var n=a["d"].fromValues(-.5,-.5,-.5,0);return a["d"].add(e,e,n),a["d"].transformMat4(e,e,s),this.mm2frac(e),e},l.prototype.scaleSlice=function(t,e){var i=this.gl.canvas.clientWidth/t;e*i>this.gl.canvas.clientHeight&&(i=this.gl.canvas.clientHeight/e);var s=t*i,n=e*i,o=[.5*(this.gl.canvas.clientWidth-s),.5*(this.gl.canvas.clientHeight-n),s,n];return o},l.prototype.drawScene=function(){this.gl.clearColor(this.opts.backColor[0],this.opts.backColor[1],this.opts.backColor[2],this.opts.backColor[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT);var t="";if(this.back.dims){if(this.sliceType===this.sliceTypeRender)return this.draw3D();var e=this.sliceScale(),i=e.volScale;if(this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.numScreenSlices=0,this.sliceType===this.sliceTypeAxial){var s=this.scaleSlice(i[0],i[1]);this.draw2D(s,0)}else if(this.sliceType===this.sliceTypeCoronal){var n=this.scaleSlice(i[0],i[2]);this.draw2D(n,1)}else if(this.sliceType===this.sliceTypeSagittal){var o=this.scaleSlice(i[1],i[2]);this.draw2D(o,2)}else{var a=this.scaleSlice(i[0]+i[1],i[1]+i[2]),r=a[2]*i[0]/(i[0]+i[1]),l=this.scaleSlice(i[0]+i[0]+i[1],Math.max(i[1],i[2])),h=l[2]*i[0]/(i[0]+i[0]+i[1]);if(h>r){var c=h/i[0],u=i[1]*c,d=i[2]*c;this.draw2D([l[0],l[1],h,u],0),this.draw2D([l[0]+h,l[1],h,d],1),this.draw2D([l[0]+h+h,l[1],u,d],2)}else{var g=a[2]-r,p=a[3]*i[1]/(i[1]+i[2]),m=a[3]-p;this.draw2D([a[0],a[1]+m,r,p],0),this.draw2D([a[0],a[1],r,m],1),this.draw2D([a[0]+r,a[1],g,m],2);var v=this.opts.colorBarMargin*p;this.drawColorbar([a[0]+r+v,a[1]+m+v,g-v-v,p*this.opts.colorbarHeight])}}var f=this.frac2mm([this.scene.crosshairPos[0],this.scene.crosshairPos[1],this.scene.crosshairPos[2]]);return t=f[0].toFixed(2)+"×"+f[1].toFixed(2)+"×"+f[2].toFixed(2),this.gl.finish(),t}}}).call(this,i("b639").Buffer)},a9e0:function(t,e,i){"use strict";i("dad8")},d109:function(t,e,i){"use strict";i("458d")},dad8:function(t,e,i){}});
//# sourceMappingURL=app.8153548d.js.map